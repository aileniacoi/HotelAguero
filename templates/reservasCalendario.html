{% extends 'base.html' %}
{% block title %}Reservas{% endblock %}

{% block content %}


<main id="main" class="main">

  <h3>Reservas</h3>

    <div class="container-fluid my-3">
        <div class="row justify-content-end">
            <div class="col-md-1">
                <a href="/calendario_reservas_pdf/{{ mes }}/{{ anio }}" class="btn btn-secondary btn-block " style="float: right;">
                    <i class="fa-regular fa-file-pdf"></i> PDF
                </a>
            </div>
        </div>
    </div>

  <div class="card">
    <div class="card-body">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <h4 class="card-header" >
                  {% if mes == 1 %}
                    <a href="/reservas/calendar/12/{{ anio|add:-1 }}"><i class="fa-solid fa-chevron-left" style="color: #223868;"></i></a>
                        {% else %}
                    <a href="/reservas/calendar/{{ mes|add:-1}}/{{ anio }}"><i class="fa-solid fa-chevron-left" style="color: #F79B03;"></i></a>
                        {% endif %}
                    <span id="nombreMes" style="font-family: 'PT Sans', sans-serif; Color: #2B4A84;"></span>
                        {% if mes == 12 %}
                    <a href="/reservas/calendar/1/{{ anio|add:1 }}"><i class="fa-solid fa-chevron-right" style="color: #223868;"></i></a>
                        {% else %}
                    <a href="/reservas/calendar/{{ mes|add:1}}/{{ anio }}"><i class="fa-solid fa-chevron-right" style="color: #F79B03;"></i></a>
                        {% endif %}
                </h4>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered" >
                <thead>
            <!--    <tr>-->
            <!--        <th colspan="{{ cantidadDias|length|add:1 }}" style="text-align:center">-->
            <!--            <h4>-->

            <!--  </h4>-->
            <!--        </th>-->
            <!--    </tr>-->
                  <tr>
                    <th class="columnasCal"></th>
                    {% for dia in cantidadDias %}
                    <th class="columnasCal">{{ dia }}</th>
                    {% endfor %}
                  </tr>
                  <tr>
                      <th class="columnasCal"></th>
                    {% for dia in cantidadDias %}
                    <th id="res_dia_{{ dia }}" class="columnasCal"></th>
                    {% endfor %}
                  </tr>
                </thead>

            <tbody>
              {% for hab in habitaciones %}
              <tr>
                <td class="columnasCal">{{ hab.numero }}</td>

                {% for dia in cantidadDias %}
                <td id="res_{{ hab.numero }}_{{ dia }}" class="columnasCal reserva" data-bs-toggle="popover"></td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
    </div>
  </div>
</main>

<script type="text/javascript">

var reservasJs = JSON.parse('{{ reservas|safe }}');

function ConvertirFecha(fechaString){
    fecha = fechaString.split("/");
    return new Date(fecha[2], fecha[1] - 1, fecha[0]);
}

function GetColorSegunReserva(nHab, fecha) {

        var reserva = reservasJs.find(f => f.idHabitacion &&
            f.idHabitacion.numero == nHab && ConvertirFecha(f.fechaIngreso) <= fecha && ConvertirFecha(f.fechaEgreso) >= fecha);

        if (!reserva)
            return;

        if (reserva.total_pagos > 0) {
            if (ConvertirFecha(reserva.fechaIngreso).getTime() == fecha.getTime()){
                return '#73DD71';
            } else{
                return '#84FD82';
            }
        } else {

            var fechaVenc = new Date();
            fechaVenc.setDate(fechaVenc.getDate() + 2);

            if(ConvertirFecha(reserva.fechaRegistro).getTime() < fechaVenc.getTime()){

                 if (ConvertirFecha(reserva.fechaIngreso).getTime() == fecha.getTime()){
                    return '#C00E0E';
                } else{
                    return '#F13939';
                }

            } else{
                if (ConvertirFecha(reserva.fechaIngreso).getTime() == fecha.getTime()){
                    return '#E1E56D';
                } else{
                    return '#FBFF8A';
                }
            }


        }
}


function CargarColoresCalendario(){
 var i = 0;
    {% for dia in cantidadDias %}
        {% for hab in habitaciones %}

            var celda = document.getElementById('res_' + {{ hab.numero }} + '_' + {{ dia }});
            var fecha = new Date({{ anio }}, {{ mes }} - 1, {{ dia }});
            var color = GetColorSegunReserva( {{ hab.numero }}, fecha);
            celda.setAttribute('style', 'background-color: ' + color);

             i += 1;
        {% endfor %}
    {% endfor %}
}

function ObtenerInfoReserva(res){
    var ret = "";

    var saldo = parseInt(res.precioTotal, 10) - res.total_pagos;

    ret += '<p><strong>Ingreso: </strong>' + res.fechaIngreso + '</p>';
    ret += '<p><strong>Egreso: </strong>' + res.fechaEgreso + '</p>';
    ret += '<p><strong>Pax: </strong>' + res.cantidadPersonas + '</p>';
    ret += '<p><strong>Saldo: </strong>$' + saldo + '</p>';
    ret += '<a class="btn btn-outline-primary" type="button" href="/reservas/edit/' + res.pk + '">Ir a Reserva</a>'

    return ret;
}

/*function SetPopoverReserva(){

    for (var i = 0; i < reservasJs.length; i++){
        var reserva = reservasJs[i];

        if (!reserva.idHabitacion) continue;

        var fechaIngresoSplit = reserva.fechaIngreso.split("/");
        var fechaEgresoSplit = reserva.fechaEgreso.split("/");
        var hab = reserva.idHabitacion.numero;

        var contentRes = ObtenerInfoReserva(reserva);
        var contentTitle = reserva.idCliente.nombreYApellido;

        var inicio = 1;
        var fin = 1;

        if (parseInt(fechaIngresoSplit[1], 10) === {{ mes }}){
            inicio = fechaIngresoSplit[0];
        }

        if (parseInt(fechaEgresoSplit[1], 10) === {{ mes }}){
            fin = fechaEgresoSplit[0];
        }
        else{
            fin = {{ cantidadDias|length }};
        }

        for (var j = inicio; j < fin; j++){
            var id = "res_" + j + "_" + hab;
            var celda = document.getElementById(id);

            var popover = new bootstrap.Popover(celda, {
            toggle: 'popover',
            trigger: 'click',
            title: contentTitle,
            html: true,
            content: contentRes});
        }
    }
}*/

function ObtenerNombreMes() {
  let fecha = new Date();
  let mesInt = {{ mes }};
  let mes = '';
  if (0 < mesInt && mesInt <= 12) {
    fecha.setMonth(mesInt - 1);
    mes = new Intl.DateTimeFormat('es-ES', { month: 'long'}).format(fecha);
  }
  document.getElementById('nombreMes').innerHTML = mes.toUpperCase() + ' ' + {{ anio }};
}

function CargarDiasDeSemana(){
    var fecha = new Date({{ anio }}, {{ mes }} - 1, 1);
    var diaSem = fecha.getDay();

    var diasSemana = {
        0: "Dom",
        1: "Lun",
        2: "Mar",
        3: "Mie",
        4: "Jue",
        5: "Vie",
        6: "Sab"
    };

    {% for dia in cantidadDias %}
        var celda = document.getElementById('res_dia_' + {{ dia }});
        celda.innerHTML = diasSemana[diaSem];

        if (diaSem < 6)
            diaSem += 1;
        else
            diaSem = 0;

    {% endfor %}
}

function CargarDatosDeInicio(){
    ObtenerNombreMes();
    CargarColoresCalendario();
    CargarDiasDeSemana();
}

function SetPopover(celda){
    var datos = celda.id.split("_")
    var diaRes =  datos[2];
    var nHab = datos[1];
    var fecha = new Date({{ anio }}, {{ mes }} - 1, diaRes);

    var reserva = reservasJs.find(f => f.idHabitacion &&
            f.idHabitacion.numero == nHab && ConvertirFecha(f.fechaIngreso) <= fecha && ConvertirFecha(f.fechaEgreso) >= fecha);

        if (!reserva)
            return;

    var contentRes = ObtenerInfoReserva(reserva);
    var contentTitle = reserva.idCliente.nombreYApellido;

    return new bootstrap.Popover(celda, {
            toggle: 'popover',
            trigger: 'click',
            title: contentTitle,
            html: true,
            sanitize: false,
            content: contentRes});
}

window.addEventListener('load', CargarDatosDeInicio());
//window.addEventListener('DOMContentLoaded', SetPopoverReserva);

const popoverTriggerList = document.getElementsByClassName('reserva')
const popoverList = [...popoverTriggerList].map(popoverTriggerEl => SetPopover(popoverTriggerEl))

</script>
{% endblock %}